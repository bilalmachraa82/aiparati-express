# AutoFund AI - Development Dockerfile
# Optimized for development with hot reload and debugging tools

FROM python:3.13-slim

# Set environment variables for development
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH="/app" \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    libpq-dev \
    vim \
    htop \
    netcat-openbsd \
    postgresql-client \
    redis-tools \
    && rm -rf /var/lib/apt/lists/*

# Create app user
RUN groupadd -r appuser && useradd -r -g appuser appuser

# Set work directory
WORKDIR /app

# Copy requirements first for better layer caching
COPY requirements.txt requirements_production.txt ./

# Install Python dependencies with dev tools
RUN pip install --upgrade pip && \
    pip install -r requirements.txt && \
    pip install -r requirements_production.txt && \
    pip install watchdog  # For auto-reload

# Create app directories
RUN mkdir -p /app/uploads /app/outputs /app/logs /app/templates /app/test_files && \
    chown -R appuser:appuser /app

# Copy application code
COPY --chown=appuser:appuser api/ ./api/
COPY --chown=appuser:appuser *.py ./
COPY --chown=appuser:appuser *.xlsx ./templates/

# Create development entrypoint script
RUN cat > /app/entrypoint-dev.sh << 'EOF'
#!/bin/bash
set -e

echo "Starting AutoFund AI Development Environment..."

# Function to wait for service
wait_for_service() {
    local host=$1
    local port=$2
    local service=$3

    echo "Waiting for $service to be ready..."
    while ! nc -z $host $port; do
        echo "Sleeping 1 second..."
        sleep 1
    done
    echo "$service is ready!"
}

# Wait for database if configured
if [ ! -z "$DATABASE_URL" ]; then
    # Extract host and port from DATABASE_URL
    if [[ $DATABASE_URL == postgresql://* ]]; then
        DB_HOST=$(echo $DATABASE_URL | sed -n 's/.*@\([^:]*\):.*/\1/p')
        DB_PORT=$(echo $DATABASE_URL | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')
        wait_for_service ${DB_HOST:-postgres} ${DB_PORT:-5432} "PostgreSQL"
    fi
fi

# Wait for Redis if configured
if [ ! -z "$REDIS_URL" ]; then
    REDIS_HOST=$(echo $REDIS_URL | sed -n 's/.*:\/\/\([^:]*\):.*/\1/p')
    REDIS_PORT=$(echo $REDIS_URL | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')
    wait_for_service ${REDIS_HOST:-redis} ${REDIS_PORT:-6379} "Redis"
fi

# Create log file
mkdir -p /app/logs
touch /app/logs/autofund_ai.log
chown appuser:appuser /app/logs/autofund_ai.log

# Show environment info
echo "========================================"
echo "AutoFund AI Development Environment"
echo "========================================"
echo "Environment: $ENVIRONMENT"
echo "Debug Mode: $DEBUG"
echo "Database: $DATABASE_URL"
echo "Redis: $REDIS_URL"
echo "API URL: http://localhost:${API_PORT:-8000}"
echo "========================================"

# Execute the command
exec "$@"
EOF

RUN chmod +x /app/entrypoint-dev.sh

# Switch to app user
USER appuser

# Expose ports
EXPOSE 8000 9090

# Set entrypoint
ENTRYPOINT ["/app/entrypoint-dev.sh"]

# Default command - use uvicorn with reload
CMD ["python", "-m", "uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload", "--log-level", "debug"]